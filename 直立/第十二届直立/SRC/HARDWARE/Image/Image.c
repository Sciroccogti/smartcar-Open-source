#include "image.h"
#include "oled.h"
#include "camera.h"
#include "extern.h"
uint8_t L_black[70];//左线点储存数组
uint8_t LCenter[70];//中线点储存数组
uint8_t R_black[70];//右线点储存数组
uint8_t P_Gather_Flag_OK = 0;
uint8_t Pixels[Pixels_H][Pixels_W], //图像数据
P_DMA[700],
P_Pixels_Temp[14000],OLED_P_Pixels[70][128];
uint8_t Thre[Pixels_H];									//阈值
uint16_t Camera_Valid_Line[Pixels_H]=
{
	  90 ,92 ,95 ,97 ,100,102,105,107,110,112,
    115,117,120,122,125,128,131,133,136,138,
    141,143,146,148,151,153,156,158,161,163,
    165,167,170,172,174,176,178,181,183,185,
    187,189,192,194,196,198,200,203,205,207,
    209,211,214,216,218,220,222,225,227,229,
    231,233,236,238,240,242,244,247,249,251,
},
//{
//	  90 ,92 ,94 ,96 ,98 ,100,102,104,106,108,
//    110,113,115,117,120,122,124,127,129,131,
//    133,136,138,140,143,145,147,150,152,154,
//    156,159,161,163,166,168,170,173,175,177,
//    179,182,184,186,189,191,193,196,198,200,
//    202,205,207,209,212,214,216,219,221,223,
//    226,229,232,235,239,243,247,251,255,259,
//},

Camera_Valid_Row[Pixels_W]=
{
//	90 ,93 ,96 ,99 ,102,104,107,110,112,115,118,120,123,126,128,130,133,136,139,142,
//145,148,151,154,157,160,163,166,169,172,175,178,181,184,187,190,193,196,199,202,
//205,208,211,214,217,220,223,226,229,232,235,238,241,244,247,250,253,256,259,262,
//265,268,271,274,277,280,283,286,289,292,295,298,301,304,307,310,313,316,319,322,
//325,328,331,334,337,340,343,346,349,352,355,358,361,364,367,370,373,376,379,382,
//385,388,391,394,397,400,403,406,409,412,415,418,421,424,427,430,433,436,439,442,
//445,448,451,454,457,460,463,466,469,472,475,478,481,484,487,490,493,496,499,502,
//505,508,511,514,517,520,523,526,529,532,535,538,541,544,547,550,553,556,559,562,
//565,568,571,574,577,580,583,586,589,592,595,598,601,604,607,610,613,616,618,621,
//624,626,629,632,634,637,640,642,645,648,650,653,656,658,661,664,667,670,673,676,
105,108,111,114,117,119,122,125,127,130,133,135,138,141,143,145,148,151,154,157,
160,163,166,169,172,175,178,181,184,187,190,193,196,199,202,205,208,211,214,217,
220,223,226,229,232,235,238,241,244,247,250,253,256,259,262,265,268,271,274,277,
280,283,286,289,292,295,298,301,304,307,310,313,316,319,322,325,328,331,334,337,
340,343,346,349,352,355,358,361,364,367,370,373,376,379,382,385,388,391,394,397,
400,403,406,409,412,415,418,421,424,427,430,433,436,439,442,445,448,451,454,457,
460,463,466,469,472,475,478,481,484,487,490,493,496,499,502,505,508,511,514,517,
520,523,526,529,532,535,538,541,544,547,550,553,556,559,562,565,568,571,574,577,
580,583,586,589,592,595,598,601,604,607,610,613,616,619,622,625,628,631,633,636,
639,641,644,647,649,652,655,657,660,663,665,668,671,673,676,679,682,685,688,691,
},



OLED_Spot_H[64] = 
{
	0,1,2,3,4,6,7,8,9,
	10,11,12,13,15,16,17,18,
	19,20,21,22,24,25,26,27,
	28,29,30,31,33,34,35,36,
  37,38,39,40,42,43,44,45,
  46,47,48,49,51,52,53,54,	
	55,56,57,58,59,60,61,62,
	63,64,65,66,67,68,69,
},
OLED_Spot_W[128] = 
{
	0,1,2,4,6,8,10,12,14,16,18,19,20,22,24,26,28,29,30,
	32,33,34,36,38,40,42,43,44,46,48,50,51,52,54,55,56,58,60,61,62,
	64,65,66,68,70,71,72,74,76,78,79,80,82,84,86,87,88,90,92,93,94,
	96,98,100,101,102,103,104,106,108,109,110,112,114,115,116,118,120,122,124,125,126,
	128,129,130,132,133,134,136,137,138,140,142,144,146,148,150,152,154,156,157,158,
	160,161,162,163,164,166,168,170,171,172,174,176,177,178,180,181,182,184,186,188,190,
	192,194,196,198,199,
};
//获取200*70图像
void Pixels_Get(void)
{
	uint8_t i=0,j=0;
	uint16_t k=0;
//	for(i=0;i<70;i++)
//	{
//	k=i*200;
//	for(j=0;j<200;j++)
//		{
//			*(Pixels[i]+(j))=*(P_Pixels_Temp+(k+j));
//		}
//	}
}
//获取OLED数组
void Get_OLED_Pixels(void)
{
	uint8_t i=0,j=0;
	for(i=0;i<64;i++)
	{
		for(j=0;j<128;j++)
		{
			*(OLED_P_Pixels[i]+j)=*(Pixels[69-*(OLED_Spot_H+i)]+199-*(OLED_Spot_W+j));
		}
	}
}
void Threshold_Change() //分行阈值
{
	uint8_t i,j;
	
	for(i=0;i<70;i++)
	{
		if(i<5)
		Thre[i]=Threshold;
		else if(i<10)
		Thre[i]=Threshold+1;
		else if(i<15)
		Thre[i]=Threshold+2;
		else if(i<20)
		Thre[i]=Threshold+3;
		else if(i<25)
		Thre[i]=Threshold+4;		
		else if(i<35)
		Thre[i]=Threshold+5;
		else if(i<45)
		Thre[i]=Threshold+6;
		else if(i<55)
		Thre[i]=Threshold+7;		
		else if(i<60)
		Thre[i]=Threshold+8;
		else if(i<70)
		Thre[i]=Threshold+10;
		
	}

	
}
//void Threshold_Change() //分行阈值
//{
//	uint8_t i,j;
//	
//	for(i=0;i<70;i++)
//	{
//		if(i<5)
//		Thre[i]=Threshold;
//		else if(i<10)
//		Thre[i]=Threshold+1;
//		else if(i<15)
//		Thre[i]=Threshold+1;
//		else if(i<20)
//		Thre[i]=Threshold+2;
//		else if(i<25)
//		Thre[i]=Threshold+2;		
//		else if(i<35)
//		Thre[i]=Threshold+3;
//		else if(i<45)
//		Thre[i]=Threshold+5;
//		else if(i<55)
//		Thre[i]=Threshold+5;		
//		else if(i<60)
//		Thre[i]=Threshold+5;
//		else if(i<70)
//		Thre[i]=Threshold+5;
//	}

//	
//}
//void Threshold_Change() //分行阈值
//{
//	uint8_t i,j;
//	
//	for(i=0;i<70;i++)
//	{
//		if(i<5)
//		Thre[i]=Threshold;
//		else if(i<10)
//		Thre[i]=Threshold;
//		else if(i<15)
//		Thre[i]=Threshold;
//		else if(i<20)
//		Thre[i]=Threshold;
//		else if(i<25)
//		Thre[i]=Threshold;		
//		else if(i<35)
//		Thre[i]=Threshold;
//		else if(i<45)
//		Thre[i]=Threshold;
//		else if(i<55)
//		Thre[i]=Threshold;		
//		else if(i<60)
//		Thre[i]=Threshold;
//		else if(i<70)
//		Thre[i]=Threshold;
//	}
//	
//}
void Show_Midline()//中线显示
{
	uint8_t i,j;
	for(i=0;i<70;i++)
	{
		for(j=0;j<200;j++)
		{
			if(j==LCenter[i]||j==L_black[i]||j==R_black[i])
				Pixels[i][j]=1;
			else
				Pixels[i][j]=0;
		}
	}
}





	



